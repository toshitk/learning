# 6.データベースサービス
## 6.1. データベースサービス
- 大きく**RDB**と**NoSQL**(Not Only SQL)に分類される

## 6.2. RDS
- **Amazon RDS**(`Relational Database Service`)はAWSのマネージドRDBサービス
- 障害からの復旧や運用をシンプルかつ低コストで実現できる
- RDSでは複数のデータベースエンジンを利用可能だが、それぞれのエンジンの機能のうちRDSでは利用できない機能も存在する
  - その場合はEC2インスタンスにエンジンをインストールする等の対応が必要
- 下記のデータベースエンジンがサポートされている
  - MySQL
  - MariaDB
  - PostgreSQL
  - Oracle 12c
  - Oracle 11g
  - Microsoft SQL Server

### ストレージタイプ
- RDSのデータ保存用のストレージはEBSを使用する
  - 使用可能なストレージタイプは「汎用SSD」、「プロビジョン度IOPS SSD」(「マグネティック」)
- ストレージ容量は32TBまで拡張可能
  - 拡張はオンライン状態で実施可能だが、拡張中は若干のパフォーマンス劣化が発生する

### 特徴
#### マルチAZ構成
- 1リージョン内の2つのAZにDBインスタンスを配置して、高可用性を実現する
- DBインスタンス作成時にマルチAZ構成を選択するだけで構築可能
- マルチAZ構成では下記に留意する
  - **書き込み速度の低下**
    - 2つのAZ間でデータを同期するため、シングルAZ構成に比べ、書き込みやコミットの所要時間が長くなる
  - **フェイルオーバーに60～120秒かかる**
    - フェイルオーバー時にはRDSへの接続用FQDNのDNSレコードがスタンバイ側のIPアドレスに書き換えられる
      - 異常を検知してDNSレコードの情報が書き換えられ、新しいIPの情報を取得するまでは接続不可
    - アプリ側でDB接続先のIPをキャッシュとして持っている場合は120秒以上かかる場合もある

#### リードレプリカ
- 参照専用のDBインスタンスを作成できる
- リードレプリカを作成することで、マスターDBの負荷を抑えたり読み込みが多いアプリにおいてDBリソースのスケールアウトを容易に実現する
- マスターとリードレプリカの同期は非同期レプリケーション方式で行われる
  - リードレプリカを参照するタイミングによってはマスター側の更新が反映されていない可能性もある
- マスターDBの性能への盈虚は与えない

#### バックアップ/リストア
- **自動バックアップ**
  - 1日に1回自動でバックアップ(DBスナップショット)を取得する
  - バックアップの保持期間は最大で35日
  - 稼働中のRDSにバックアップのデータを戻すことはできず、スナップショットを指定して新規RDSの作成のみでデータを戻すことができる
- **手動スナップショット**
  - 任意のタイミングでスナップショットを取得できる
  - 手動スナップショットは1リージョンあたり100個まで
  - シングルAZ構成の場合は取得時に短時間のI/O中断が発生する(自動バックアップも同様)
    - マルチAZ構成の場合はスタンバイ側のインスタンスからスナップショットを取得するため、性能影響はない
- **リストア**
  - スナップショットを指定し、新規RDSを作成することでリストア可能
- **ポイントタイムリカバリー**
  - 直近5分前から最大35日前までのにんいのタイミングの状態のRDSを新規で作成することができる
  - 自動バックアップが有効な場合のみ利用可能で、取得期間は自動バックアップに準ずる

#### セキュリティ
- **ネットワークセキュリティ**
  - RDSはVPC内で使用可能
  - EC2とうようにセキュリティグループによる通信要件の制限が可能
- **データ暗号化**
  - RDSの暗号化オプションを有効日することでデータが保存されるストレージ(リードレプリカ用を含む)やスナップショットだけでなく、ログ等のRDSに関する全てのデータが暗号化された状態で保存されるようになる
  - このオプションは途中から有効化することができない
    - すでにあるデータを暗号化したい場合はスナップショットを取得して、スナップショットの暗号化コピーを実施し、暗号化されたスナップショットから新規にDBインスタンスを作成する

### Amazon Aurora
- **Amazon Aurora**はAWSが独自に開発したデータベースエンジン
- MySQｌ、PostgreSQLと互換性を持つ

#### 構成要素
- DBインスタンスを作成すると同時にDBクラスタが作成される
  - DBクラスタは1つ以上のDBインスタンスと、各DBインスタンスから参照するデータストレージで構成される
    - データストレージはSSDをベースにしたクラスタボリュームでで、クラスタボリュームは単一リージョン内の3つのAZにそれぞれ2つのデータコピーで構成され、各ストレージは自動的に同期される
- クラスタボリュームは作成時に容量を指定する必要がなく、Aurora内に保存されるデータ量に応じて64TBまで自動的に拡縮する

#### Auroraレプリカ
- Auroraは他のRDSを異なり、マルチAZ構成オプションは存在しない
- Auroraクラスタ内に参照専用のレプリカを作成することは可能
  - 他のRDSのリードレプリカとは異なり、プライマリインスタンスに障害が発生した場合にレプリカインスタンスがプライマリに昇格し、フェイルオーバーが実現する

#### エンドポイント
- Auroraには下記の3種類のエンドポイントが作成される
  - **クラスタエンドポイント**
    - プライマリインスタンスに接続するためのエンドポイント
    - クラスタエンドポイント経由で接続した場合、データベースへの全ての操作(参照/作成/更新等)が可能
  - **読み取りエンドポイント**
    - レプリカインスタンスに接続する
    - 読み取りエンドポイント経由で接続した場合、参照のみの操作が可能
    - 複数のレプリカインスタンスが存在する場合は自動的に負荷分散が行われる
  - **インスタンスエンドポイント**
    - Auroraクラスタを構成する各DBインスタンスに接続するためのエンドポイント
    - 特定のDBインスタンスに接続したい場合に使用する

### 6.3.　RedShift
- **RedShift**はデータウェアハウス向けのデータベースサービス
- 従来の一般的なデータウェアハウスの導入コストの1/10～1/100程度で開始することができる

#### 構成
- 1つのRedShiftを構成する複数のノードのまとまりを**RedShiftクラスタ**と呼ぶ
  - クラスタは1つの**リーダーノード**と複数の**コンピュートノード**から構成される
    - リーダーノード
      - SQLクライアントやBIツールからの実行クエリを受け付けてクエリの解析や実行プランの作成を行う
    - コンピュートノード
      - リーダーノードからの実行クエリを処理するノード
      - ストレージとセットになっている
    - ノードスライス
      - RedShiftが分散並列処理をする最小単位
      - コンピュートノード内でさらにリソースを分割してスライスをいう単位を構成する

### 特徴
#### 列指向型(Columnar)データベース
- データウェアハウスでは大量データに対して集計処理を実行するため、データI/Oがボトルネックとなることが多い
  - 列指向型データベースはデータを列単位で管理し、データ取得を効率化する

#### 圧縮エンコード方式
- データI/Oのボトルネックを発生させないために取得するデータ量を削減するアプローチもある
  - RedShiftは9種類の圧縮エンコード方式に対応しており、列ごとに圧縮方式を指定可能

#### ゾーンマップ
- RedShiftではブロック単位でデータが格納される
  - 1ブロックの容量は1MB
- **ゾーンマップ**とは、ブロック内に格納されているで0他の最小値と最大値をメモリに保存する仕組みで、検索条件に該当する値の有無を効率的に判断できる

#### 拡張性
- **MPP**(Massively Parallel Processing)
  - 1回の集計処理を複数ノードに分散して実行する仕組み
  - スケールアウトによって分散並列処理のパフォーマンスを向上させることができる
- **シェアードナッシング**
  - 各ノードがディスクを共有せず、ノードとディスクのセットで拡張する仕組み
  - 複数ノードが同一ディスクを共有することによるI/O性能劣化を回避する

#### RedShift Spectrum
- **RedShift Spectrum**はS3に配置されたデータを外部テーブルとして定義できるようにし、データを取り込むことなくクエリ実行を可能にするサービス
- 従来は下記の課題があったが、RedShift Spectrumによって解決された
  - S3からRedShiftへのデータ移行に時間がかかる
  - データ量の増加に伴いRedShiftクラスタの容量も拡張する必要があるが、CPUやメモリも追加されコストが高くなる

##　6.4. DynamoDB
- **Amazon DynamoDB**はAWSのマネージドNoSQLデータベースサービス

### 特徴
#### 高可用性設計
- SPOFを持たない構成
- データは自動的に3つのAZに保存される

#### スループットキャパシティ
- DynamoDBを使用する場合は、テーブルやインデックスを作成する際に読み取り、書き込みに必要なスループットを指定する
- このスループットはいつでもダウンタイムなしで変更可能
  - **RCU**(Read Capacity Unit)
    - 読み取りスループットキャパシティの指標
  - **WCU**(Write Capacity Unit)
    - 書き込みスループットキャパシティの指標
- スループットキャパシティの変更は増加させる分には制限はないが、減少は1日9回までという制限が存在する
- スループットキャパシティの自動スケーリングも存在するが、EC2のAuto Scalingと同様にスパイクには対応不可のため手動で拡張する必要がある

#### プライマリーキーとインデックス
- プライマリーキーはデータ項目を一意に特定するための属性で、「パーティションキー単独」と「パーティションキーとソートキーの組合わせ」の2種類がある
- パーティションキーのみで一意に特定できない場合はソートキーと組み合わせてプライマリーキーを構成する
- **ローカルセカンダリインデックス(LSI)**
  - プライマリーキーはテーブルで指定したパーティションキーと同じで、別の属性をソートキーとして作成するインデックス
- **グローバルセカンダリインデックス(GSI)**
  - プライマリーキーとは異なる属性を使って作成するインデックス
- セカンダリインデックスは作成した文だけデータ容量を確保する必要があったり、別のキャパシティユニットが必要であるため、複数のセカンダリインデックスを作成する場合はRDBへの変更も検討する

#### TTL(Time to Live)
- DynamoDB内では有効期限を過ぎたデータは自動的に削除される
- 有効期限が切れたデータは即時に削除されるのではなく、48時間以内に削除される
- 自動メンテナンスによるデータ削除はキャパシティユニットは使用されない

#### DynamoDB Streams
- DynamoDBに対して行われた直近24時間以内の追加/更新・削除の履歴を保持する機能
- データが変更されたタイミングを検知できるため、変更内容に応じた処理をリアルタイムに実行するなどの仕組みが構築可能

#### Consistent Read
- Consistent Readのオプションを有効にすると、参照のリクエストがあった時点よりも前に書き込まれているデータが全て反映された状態のデータを元に参照結果を返す
- オプションを有効化するとRCUは2倍消費する

#### DynamoDB Accelerator(DAX)
- DynamoDBの前段にキャッシュクラスタを構成する拡張サービス
- DAXを利用すると毎秒数百件の読み取り処理もマイクロ秒単位で応答を返す
- 性能が向上するだけでなく、DBへの直接読み取り操作の頻度が減少するため、RCUの確保を抑えコスト削減にも貢献する

## 6.5. ElastiCache
- **ElastiCache**はインメモリ型データベースサービス
- 高頻度で参照するデータや検索に時間のかかるデータセットをメモリ上に保持することでパフォーマンスを向上させる
- **Memcached**と**Redis**の2つのエンジンをサポートしている
- Memcached
  - KVS型インメモリデータベース
  - データの永続機能はない
  - 下記の場合に用いられる
    - シンプルなキャッシュシステムを利用したい
    - データが消えたとしてもシステムの動作には大きな影響は与えない
    - キャッシュリソースが増減が頻繁で、スケールアウト/インをする必要がある
- Redis
  - KVS型インメモリデータベース
  - Memcachedよりも多くのデータ型が扱える
  - ノード間のレプリケーションやデータ永続化機能を持っている
  - 下記の場合に用いられる
    - 文字列、リスト、セット等の多様なデータ型を扱いたい
    - キーストアに永続性を持たせたい
    - 障害時の自動的なフェイルオーバーやバックアップ/リストア等の可用性が欲しい

### Memcached
#### クラスタ構成
- 最大20のElastiCacheインスタンスでクラスタが構成される
- クラスタ内に保存されるデータは各インスタンスに分散される
- クラスタ作成時に下記の2つのエンドポイントが作成される

|エンドポイント|概要|
|---|---|
|ノードエンドポイント|クラスタ内の各ノードに個別にアクセスするためのエンドポイント|
|設定エンドポイント|クラスタ全体に割り当てられるエンドポイント<br>アプリケーションからElastiCacheサービスに接続する際はこのエンドポイントを利用する|

#### スケーリング
- Memcachedクラスタではスケールアウト/イン、アップ/ダウンでリソースを調節可能
- スケールアウト/イン時の注意点
  - クラスタ内のデータが各ノードに分散して保存されるため、ノード数が増減した場合正しいノードにデータが再マッピングされるまでの間、キャッシュミスが発生することがある
- スケールアップ/ダウン時の注意点
  - 新規でクラスタを作成する必要がある
  - データの永続性はないため、保持しているデータは全て削除される
