# 5. ストレージサービス
## 5.1. AWSのストレージサービス
### ストレージサービスの分類とタイプ
- AWSが提供するストレージサービスは下記の5つ

|サービス名|
|---|
|Amazon EBS|
|Amazon EFS|
|Amazon S3|
|Amazon Glacier|
|AWS Storage Gateway|

- ストレージサービスは一般的に次の3つのタイプに分類できる
  - **ブロックストレージ**
    - データを物理的なディスクにブロック単位で管理する
    - 頻繁に変更されたり高速なアクセスが必要とされる用途で使用される
    - AWSではEBSが該当する
  - **ファイルストレージ**
    - ブロックストレージ上にファイルシステムを構築してデータをファイル単位で管理する
    - 複数のクライアントからネットワーク経由で共有する際や、過去データをまとめて保存したりといった用途で使用される
    - AWSではEFSが該当する
  - **オブジェクトストレージ**
    - ファイルに任意のメタデータを追加してオブジェクトとして管理する
    - ファイルの内容を直接操作することはできず、HTTP(S)経由の登録・削除・参照が可能
    - 更新頻度の少ないデータや大容量のマルチメディアコンテンツを保存する用途で使用される
    - AWSではS3とGlacierが該当する|

||ブロックストレージ|ファイルストレージ|オブジェクトストレージ|
|---|---|---|---|
|管理単位|ブロック|ファイル|オブジェクト|
|データライフサイクル|追加・更新・削除|追加・更新・削除|追加・削除|
|プロトコル|SATA, SCSI, FC|CIFS, NFS|HTTP(S)|
|メタデータ|固定情報のみ|固定情報のみ|カスタマイズ可能|
|ユースケース|DB、トランザクションログ|ファイル共有、データアーカイブ|マルチメディアコンテンツ、データ・アーカイブ|

## 5.2. EBS
- `Elastic Block Store`の略でブロックストレージサービス
- EC2のOS領域や追加ボリューム、RDSのデータ保存用としてアタッチ可能
- 複数のEC2インスタンスにアタッチすることは不可
- 作成時にAZを指定し、異なるAZのインスタンスにはアタッチ不可
  - 異なるAZのインスタンスにアタッチしたい場合は、EBSのスナップショットを取得して、スナップショットから異なるAZにEBSボリュームを作成する
<!--  図入れる -->

### EBSのボリュームタイプ
- ボリュームタイプは下記の2種類

|ボリュームタイプ|
|---|
|汎用SSD(gp2)|
|プロビジョンドIOPS SSD(io1)|
|スループット最適化HDD(st1)|
|Cold HDD(sc1)|

### 汎用SSD(gp2)
- 一般的なボリュームタイプでEC2インスタンス作成にデフォルトとして選択されている
- `IOPS`(Input/Output Per Second)を性能指標として、`3IOPS/GB`から`10,000OIPS/ボリューム`まで容量に応じたベースライン性能がある
- ベースライン性能はEBS利用時間の99%で満たされる
- 1TB未満のボリュームには一定期間3,000IOPSまで性能を向上させるバースト機能が存在する

### プロビジョンドIOPS(io1)
- EBSの中で最も高性能なSSDベースのボリュームタイプ(DBによく用いられる)
- 最大`50IOPS/GB`、もしくは最大`64,000IOPS/ボリューム`まで容量に応じたベースライン性能がある
- 上記はEBS利用時間の99.9%で満たされる
- スループットもボリュームあたり最大1,000MB/sまででるため、IO負荷が高いケースとスループットが必要なケースに適している

### スループット最適化HDD(st1)
- HDDベースのスループット重視のタイプで、ログデータに対する処理やバッチ処理等の大容量ファイルを高速で読み込むような処理に適している
- スループット(MB/s)を性能指標としており、`1TBあたり40MB/s`、最大で`ボリュームあたり500MB/s`をベースライン性能としている
- 上記はEBS利用時間の99%で満たされる

### Cold HDD(sc1)
- sc1は性能面では他のタイプに劣るが、最も低コストなボリュームタイプ
- 性能を求められないデータへのアクセスやアーカイブ領域として用いられる
- `!TBあたり12MB/s`、最大で`ボリュームあたり250MB/s`をベースライン性能としている

||gp2|io1|st1|sc1|
|---|---|---|---|---|
|ユースケース例|EC2のOS領域|DBのデータ領域|バッチ処理|アクセス頻度の低いアーカイブデータ|
|ボリュームサイズ|1GB - 16TB|4GB - 16TB|500GB - 16TB|500GB - 16TB|
|最大IOPS/ボリューム|10,000|64,000|500|250|
|最大スループット/ボリューム|160MB/s|1,000MB/s|500MB/s|250MB/s|
|ベースライン性能|3IOPS/GB|指定されたIOPS|1TBあたり40MB/s|1TBあたり12MB/s|
|バースト性能|ボリュームあたり3,000IOPS|指定されたIOPS|1TBあたり最大250MB/s|1TBあたり最大80MB/s|

### ベースライン性能とバースト性能
- プロビジョンドIOPS以外のストレージタイプには容量に応じたベースライン性能が存在する
- ベースライン性能とは別に、処理量の一時的な増加に対応可能な**バースト性能**という指標がある
  - あくまで一時的な対応のためバースト性能に頼ったサイジングをしないようにする

### EBSの拡張
#### 容量拡張
- すべてのタイプのEBSは1ボリュームあたりの最大容量が16TB
- EBSのサイズ変更は何度でも可能だが、オンライン中に拡張を実施した場合はファイルシステムの拡張作業(Linuxであればresize2fs等)を行い、OS側に認識させる

#### ボリュームタイプの変更
- 4つのタイプの間で変更が可能(gp2だとIOPSが足りなかったためio1に変更したい等)
  - IOPSの変更には最大24時間以上かかる場合があるため注意

#### 可用性/耐久性
- EBSは内部的にAZ内の複数の物理ディスクに複製が行われているため、物理故障が発生しても利用者が意識することはない
- スナップショット機能も存在するため、定期的にバックアップを取得することで必要な時点に戻すことも可能

#### セキュリティ
- 暗号化オプションを有効化すると、ボリュームが暗号化されるだけでなく、暗号化されたボリュームから取得したスナップショットも暗号化される
- 暗号化処理はEC2インスタンスが起動するホストで実施されるためEBS間を跨ぐデータ通信時のデータも暗号化された状態となる
- すでに作成済みのEBSを暗号化した場合は下記の手順となる
  - EBSのスナップショットを取得
  - スナップショットを暗号化
  - 暗号化されたスナップショットから新規EBSを作成
  - EC2インスタンスにアタッチしているEBSを差し替え

## 5.3. EFS
- **Elastic File System**の略で、容量無制限で複数のEC2インスタンスから同時にアクセスが可能なファイルストレージサービス
- EFSへの接続は一般的なNFSをサポートしているため、NFSクライアントさえあれば特別なツールをインストールする必要はない

### EFSの構成要素
- EFSはファイルシステム、マウントターゲット、セキュリティグループから構成される
- EFSはファイルが作成されると自動的に3箇所以上のAZに保存される分散ファイルシステムを構成する
- 作成したファイルシステムにアクセスするためにAZごとにサブネットを指定して**マウントターゲット**を作成する
<!-- 図 -->

### パフォーマンスモード
- **汎用パフォーマンスモード**と**最大I/Oパフォーマンスモード**の2種類のモードが存在するが、ほとんどの場合は汎用パオ-マンスモードを使用する
- モードは作成後に変更できない
- 汎用パフォーマンスモードで性能テストを実施し、CloudWatchの**PercentlLimit**というメトリクスが長時間高い状態にある場合は最大I/Oパフォーマンスモードを採用したほうがよい場合がある

### スループット
- パフォーマンスモードとは別に**バーストスループットモード**と**プロビジョニングスループット**が存在する
- バーストスループットモード
  - 一時的なスループットの上昇に耐えられるようなバースト機能を持ったモード
  - ベースラインのスループットは1GBあたり50KB/sで、データ量に応じてスループットと期間が設定されている
  - 最低バーストスループットは100MB/sで、1TBを超えると毎日12時間、ストレージの1TBあたり100MB/sまでバーストできるバーストクレジットが貯まる

  |ファイルシステムサイズ(GB)|ベースラインスループット(MB/s)|バーストスループット(MB/s)|最大バースト期間(s/日)|
  |---|---|---|---|
  |10|0.5|100|7.2|
  |256|12.5|100|180|
  |1024|50.0|100|720|
  |2048|100.0|200|720|

- プロビジョニングスループットモード
  - バーストスループットモードよりも高い性能が必要な場合等に任意(最大1GB/s)のスループットを指定できる
  - 申請することで1GB/sよりも大きなスループットを出すことも可能
  - 指定したスループット値の増減は
- どちらのモードを選択するかを見分ける指標としてCloudWatchの**BurstCreditBalance**というメトリクスが参考となる
- クレジットバランスを全て使い切ったり常に減少傾向にある場合は、プロビジョニングスループットモードを選択する
- スループットモード、プロビジョニングスループットモードのスループット値はEBS運用中にも変更可能
  - ただし、モード変更とスループット値の削減は前回操作から24時間以上空ける必要がある

## S3
- **Simple Storage Service**の略で、ディレクトリ構造を持たないことやデータに対してメタデータを付与できる点が特徴
- RESTやSOAPといったHTTPベースのAPIで操作が可能
- 主なユースケースは下記
  - データバックアップ
  - データレイク
  - ETL(Extract/Transform/Load)の中間ファイル保存
  - Auo Scaling構成のEC2インスタンス等からのログ転送先
  - 静的コンテンツのホスティング
  - 簡易的なKey-Value型データベース

### 構成要素
- 下記の3要素から構成される

|要素|概要|
|---|---|
|バケット|オブジェクトを保存するための領域<br>バケット名はアカウントやリージョン関係なくAWS内で一意にする必要がある|
|オブジェクト|S3に格納されるデータ<br>各オブジェクトには`バケット名 + キー名 + バージョンID`で必ず一意となるURLが発行される<br>オブジェクト数に制限はないが、1オブジェクトの最大データは5TB|
|メタデータ|オブジェクトを管理するための情報<br>作成日時やサイズ等だけでなく、アプリで必要な情報もユーザ定義メタデータとして保持可能|

### 耐久性と整合性
- S3に保存されたデータは複数AZ、またAZ内の複数の物理ストレージに複製され、高い耐久性をもっている
- データ複製方式は**結果整合性方式**を採用しているため、複製が完全に終わるまでの間にデータを参照すると保存前の状態が表示されることもある

### ストレージクラス
- 用途に応じて5つのクラスが用意されている

|クラス|概要|耐久性|可用性|
|---|---|---|---|
|STANDARD|デフォルトのストレージクラス|99.999999999%(イレブンナイン)|99.99%|
|STANDARD-IA|STANDARDに比べて格納コストが安価なクラス<br>データの読み出し容量に対する従量課金制<br>参照頻度が低いデータの保存に適している|99.999999999%(イレブンナイン)|99.9%|
|ONEZONE-IA|単一のAZのみでデータを複製するクラス<br>AZ単位の障害発生時にデータが消失する可能性がある<br>それ以外はSTANDARD-IAと同等|99.999999999%(イレブンナイン)|99.5%|
|INTELLIGENT-TIERING|STANDARDとSTANDARD-IAの2層構成となっており、30日以上参照されなかったデータは自動的にSTANDARD-IAに移動される<br>自動化できる反面頻繁にデータの移動が行われると高コストとなる可能性がある|99.999999999%(イレブンナイン)|99.9%|
|GLACIER|新規作成時には選択不可で、後述するライフサイクル管理機能を使用してこのクラスを指定できる<br>ほとんど参照されないアーカイブ目的のデータの保存に適している|99.999999999%(イレブンナイン)|99.99%|

### ライフサイクル管理
- S3に保存されたオブジェクトは利用頻度に応じてライフサイクルを下記の2つから設定できる

#### 移行アクション
- データの利用頻度に応じてストレージクラスを変更するアクション
<!-- 図 -->

#### 有効期限アクション
- 指定された期限を超えたオブジェクトを削除するアクション
- S3は保存容量に対する従量課金制のためコスト削減に寄与する
<!-- 図 -->

### バージョニング
- 1つのオブジェクトに対して複数のバージョンを管理することが可能
- バケット単位で有効/無効が選択できる
- バージョニングされたオブジェクトは差分管理されるのではなく、新/旧のオブジェクトが保存されるため、両バージョンの保存容量が必要となる

### Webサイトホスティング
- S3では静的コンテンツに限ってWebサイトとしてホスティングする環境を作成できる
  - 通常の利用と同様にS3にコンテンツを配置するだけでOK
- S3のWebサイトホスティングを設定すると自動的にドメイン(FQDN)が作成され、独自ドメインを利用したい場合は、Route 53等のDNSにCNAME情報を設定する

### アクセス管理
- アクセス管理にはバケットポリシー、ACL、IAMが使える

||バケットポリシー|ACL|IAM|
|---|---|---|---|
|AWSアカウント単位の制御|○|○|×|
|IAMユーザ単位の制御|△|×|○|
|S3バケット単位の制御|○|○|○|
|S3オブジェクト単位の制御|○|○|○|
|IPアドレス・ドメイン単位の制御|○|×|○|

- **バケットポリシー**はバケットに保存される全オブジェクトに適用されるため、バケットの用途に応じた制御を行う際に有効
- **ACL**はオブジェクト単位で公開/非公開を制御する場合に使用
- **IAM**はユーザ単位で制御する場合に使用

### 署名付きURL
- **署名付きURL**はアクセスを許可したいオブジェクトに対して期限を指定してURLを発行する機能
- ユーザ制御でないためURLを知っていれば期間中は誰でもアクセス可能

### データ暗号化
- **サーバ側での暗号化**と**クライアント側での暗号化**が選択できる
- サーバ側での暗号化はストレージに書き込まれる際に暗号化、読み出しの際に復号化される
- クライアント側での暗号化はAWS SDKを使ってS3に送信する前にデータが暗号化され、メタデータからどのキーで復号化するかを判別し復号化される

## 5.5. Glacier
- S3と同様の耐久性を持ち、さらに容量あたりの費用を抑えたアーカイブストレージサービス
### 構成要素
- 次の4つから構成される

|要素|概要|
|---|---|
|ボールト|アーカイブを保存する領域でS3のバケットに相当する<br>ボールト名はリージョン及びアカウント内で一意であればOK|
|アーカイブ|Glacierに格納されるデータ自身でS3のオブジェクトに相当する<br>一意のアーカイブIDとオプションの説明が付与される|
|インベントリ|各ボールトのアーカイブの情報(サイズ、作成日等)を収集する<br>約1回/日の頻度で更新されるため最新の情報が反映されるまでラグがある<br>最新の情報を確認する場合はAPIを実行する|
|ジョブ|アーカイブやインベントリに検索をかけたり、データをダウンロードするといった要求に対して処理を実行する|

### データ取り出しオプション
- Glacierにアーカイブしたデータを閲覧するためにはデータ取り出しリクエストが必要
  - 取り出しリクエストから取り出しまでの待ち時間に応じて、**高速**、**標準**、**バルク**の3種類のリクエストオプションが存在する

### Glacier Select
- 通常Glacierのデータを参照するためには読み出しリクエストを行い、一定時間待つ必要があるが、**Glacier Select**ではデータに対してSQLを発行して条件にあったデータを抽出できる
  - 対象データが非圧縮のCSV形式でないといけない等の条件あり

### データ暗号化
- データを保存する際にはSSLを使用して転送が行われる
- 暗号化は標準で行われるが、独自の方式で暗号化したい際はアップロード前に暗号化を行っておく

## 5.6. Storage Gateway
- オンプレにあるデータをクラウドへ連携するための受け口を提供するサービス

### タイプ
- 下記のようなタイプがある

|ゲートウェイタイプ|ボリューム管理|配置先|S3での保存単位|S3への保存タイミング|プライマリデータの保存場所|ファイルキャッシュ|クライアントIF|S3 APIからのアクセス|
|---|---|---|---|---|---|---|---|---|
|ファイル|-|オンプレ、EC2|ファイル|非同期(ほぼリアルタイム)|S3|あり(一部)|NFS|可|
|ボリューム|キャッシュ型|オンプレ、EC2|ボリューム|非同期スナップショット|S3|あり(一部)|iSCSI|不可|
|ボリューム|保管型|オンプレ|ボリューム|非同期スナップショット|ローカルディスク|あり(全部)|iSCSI|不可|
|テープ|-|オンプレ、EC2|仮想テープ|非同期バックアップ|ローカルディスク|なし|iSCSI|不可|

### ファイルゲートウェイ
- S3をクライアントサーバーからNFSマウントして、あたかもファイルシステムのように扱うことのができるゲートウェイ
- 作成されたファイルは非同期(ほぼリアルタイム)でS3にアップロードされる
- 1ファイルふごとにS3オブジェクトとｓｈちえ扱われるため、API経由でファイルにアクセスすることが可能
- データの書き込み/読み込みの速度はローカルディスクに比べて遅いことに注意

### ボリュームゲートウェイ
- データをS3に保存するという点ではファイルゲートウェイと同じだが、各ファイルをオブジェクトではなく、、S3のデータ保存領域全体を1つのボリュームとして管理する
- クライアントからの接続方式は**iSCSI接続**となる
- ボリュームからスナップショットを取得し、そのスナップショットからEBSを作成し、EC2インスタンスにアタッチすることでスナップショットを取得した時点のデータにアクセス可能となる

#### キャッシュ型ボリューム
- 頻繁に利用するデータはゲートウェイ内のキャッシュに保存し、プライマリストレージとしてS3を利用する
- キャッシュボリュームとアップロードバッファボリュームが存在する
  - キャッシュボリューム：頻繁にアクセスされるファイルを管理する
  - アップロードバッファボリューム：S3にアップするデータを一時的に管理する

#### 保管型ボリューム
- プライマリストレージとしてローカルストレージを使用し、データを定期的にスナップショット形式でS3へ転送する
- 全てのデータがローカルストレージに保管されるため、アクセス速度はStorage Gateway導入によって変化しない

### テープゲートウェイ
- テープデバイスの代替としてS3やGlacierにバックアップする
- サードパーティ製のバックアップアプリケーションと組み合わせることが可能なため、バックアップにテープデバイスを使用している場合は比較的簡単に移行可能

### セキュリティ
- Storage Gatewayには下記の3つのセキュリティ要素がある
  - **CHAP認証**
    - クライアントからStorage GatewayにiSCSIで接続する際に、CHAP認証が設定可能
    - クライアントのなりすましや通信の盗聴を防止できる
  - **データ暗号化**
    - AWS KMSを使用してデータの暗号化が可能
    - 暗号化のタイミングはデータが保管される(S3に保存される)タイミング
    - 暗号化されたボリュームから取得したスナップショットも同じキーで暗号化される
  - **通信の暗号化**
    - オンプレ環境からStorage Gateway経由でS3にデータを転送する際はHTTPS使用され、通信は暗号化される
