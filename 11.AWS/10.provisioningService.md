# 10. プロビジョニングサービス
## 10.1. プロビジョニングサービス
- クラウドでは同じ、または似たような環境を何度も作ることが多いため、AWSでは下記の環境構築自動化/プロビジョニングサービスが提供されている

|サービス|概要|
|---|---|
|Elastic Beanstalk|定番構成の自動構築|
|OpsWorks|Chef環境を提供し、OSより上のレイヤーの自動構築をサポート|
|CloudFormation|JSONおるいはYAMLのテンプレートを作成し、OSより下のレイヤーの自動構築をサポート|

## 10.2 Elastic Beanstalk
### 構築可能な環境
- 大きく下記2つの定番の構成を構築できる
  - Webサーバ構成(ELB + Auto Scaling + EC2)
  - Batchワーカ構成(SQS + Auto Scaling + EC2)
- それぞれで無料利用枠をなるべく使う低コスト構成と、複数サーバを用意しAuto Scalingを含める高可用構成を選択できる

### 利用方法
- マネジメントコンソール以外にも、EclipseからElastic Beanstalkの機能を利用する**AWS Toolkit for Eclipse**というツールも提供されている
- **EB CLI**というクライアントツールも提供されている
  - Elastic BeanstalkのAPIを束ねたコマンドを実行可能であり、AWS CLIよりも直感的に作業ができる

### アプリケーションデプロイサポート
- アプリケーションのデプロイをサポートする機能も存在する
- 下記のデプロイ方式を選択可能

|方式|概要|メリット|デメリット|
|---|---|---|---|
|All at Onceデプロイ|全ての「既存の」インスタンスに同時にデプロイを行う|所要時間が少ない|システム全体にダウンタイムが発生する<br>切り戻しのためには元のモジュールをデプロイし直すことになる|
|Rollingデプロイ|「既存の」インスタンスのうち一部をELBから切り離しデプロイを行う<br>デプロイが済んだインスタンスがELBアタッチされたことを確認し、残りのインスタンスにデプロイを行う<br>最初にデプロイするインスタンスの数は指定可能|システム全体のダウンタイムがない<br>デプロイが失敗したとしても最初にデプロイしたインスタンスは切り離されているため影響が少ない|All at Once方式よりも時間がかかる<br>一時的に縮退構成となる|
|Rolling with additional batchデプロイ|インスタンスを「新規に」作成しデプロイする<br>デプロイが済んだ新インスタンスがELBにアタッチされたことを確認し、一部の「既存の」インスタンスにデプロイする<br>正常に処理が終了したら残っている「既存の」インスタンスを終了する|Rollingデプロイよりもリスクが小さい|Rollingデプロイよりも時間がかかる<br>一時的にバージョンの異なるアプリがELBに紐づく<br>インスタンスが使い捨てになるためステートレスな設計が必要|
|Immutableデプロイ|インスタンスを「新規に」作成しデプロイする<br>デプロイが済んだ新インスタンスがELBにアタッチされたことを確認し、残りのインスタンスの数だけ「新規に」インスタンスを作成しデプロイする<br>正常に処理が終了したら「既存の」インスタンスを終了する|Rolling with additional batchよりもリスクが小さい|Rolling with additional batchよりも時間がかかる|
|ebコマンドによるURL Swapデプロイ|ebコマンドを利用してCNAMEを切り替えるブルーグリーンデプロイ|事前に新環境でアプリの動確をしてから切り替えを行える<br>切り戻しが容易|時間がかかる<br>ELBも新しくなるため高負荷時はプレウォーミングが必要<br>DNSキャッシュの考慮が必要|
|ebコマンドによるRoute 53レイヤでの切り替えデプロイ|ebコマンドを利用してRoute 53の設定を変更するブルーグリーンデプロイ|URL Swapデプロイと同じ|URL Swapデプロイと同じ|

## 10.3. OpsWorks
- **OpsWorks**はChefを利用した構成管理サービス
- Chefの利用方式には下記の2通りが存在する
  - **Chef Clientローカル方式**
    - 各サーバがレシピを持ち、自分自身にレシピを適用する方式
  - **Chef Server/Client方式**
    - マスターサーバを用意し、レシピそのものや各サービスへのレシピ適用状況を管理する方式
- どちらの方式を用いる場合もChef環境のセットアップが必要になるが、OpsWorksを使用するとセットアップを行ってくれる

### OpsWorksスタック
- Chef Clientローカル方式でChefを利用する場合はOpsWorksスタックを用いる
  - スタック
    - OpsWorksのトップエンティティ
    - スタック単位の構成情報をJSON形式で保持する
    - スタックの下に複数レイヤーを定義できる
  - レイヤー
    - インスタンスの特性ごとにレイヤーを用意する
    - レイヤーを指定してEC2インスタンスを起動することで、インスタンスに対してレシピが適用される

- スタックをコピーすることも可能なので、東京リージョンで環境を作成し、DR環境を別リージョンにコピーするというような使い方ができる
- レイヤー内で起動したEC2インスタンスにはOpsWorksエージェントがインストールされ、エージェントがOpsWorksからレシピを取得して自身のインスタンスに適用する(OpsWorksへの通信経路が必要)

### OpsWorks for Chef Automate
- Chef Server/Client方式で利用する場合は**Chef Automate**を利用する
- Chef Automateを利用すると、Automateサーバが自動構築される
  - サーバのプロビジョニングやインストール作業は利用者が行う必要がなく、自身のバックアップを行う機能等も提供される

## 10.4. CloudFormation
- **CloudFormation**はAWSリソースを自動構築するためのサービス
- 下記で流れで使用する
  - CloudFormationテンプレートを作成する
  - テンプレートを適用する
  - CloudFormationスタックが作成され、スタックに紐づく形でAWSリソースが自動構築される

### スタック
- テンプレートで管理するリソースのまとまり
  - e.g. VPC1つとEC2インスタンス2つ
- 同じテンプレートを使用して別のスタックを作成することも可能

### テンプレート
- JSONかYAML形式で記述されるスタックの設計図
