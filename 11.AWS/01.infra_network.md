# 1. グローバルインフラストラクチャとネットワーク
## 1.1. リージョンとAZ
- **AZ**
  - `Availability Zone`の略
  - AZは複数のDCで構成されている
  - 地理的災害等で複数のAZで障害が起きないように、AZ同士は数10km程度離れて配置される
    - AZ間は専用線でつながっているので、ネットワークレイテンシは2ms以下
    - 停電対策で電源系統も分離している
- **リージョン**
  - AWSがサービスを提供している拠点で、リージョン同士は地理的に離れた場所に配置されている(e.g. 東京とバージニア北部)
  - リージョンは複数のAZで構成されている
- システムをマルチAZで構成することで可用性を高めることができる
- 通信制御はセキュリティグループとネットワークACLによって行われる

## 1.2. VPC
- `Virtual Private Cloud`の略
- プライベートな仮想ネットワークをAWS内に構築する
- `Internet GateWay`(IGW)を通じてインターネットに出ることもできるし、`Virtual private GateWay`(VGW)を通じてインターネットに出ることなくオンプレの拠点と通信することが可能
- /16から/28の範囲でCIDRブロックを作成することが可能

![](./images/01-1.multiAZ.png)

### サブネット
- EC2インスタンス等を起動するための、VPC内部に作成するアドレスレンジ
- VPCに設定したCIDRブロックの範囲に収まる小さなCIDRブロックを割り当てることが可能
- サブネットごとに1つのルートテーブルと1つのACLを指定する
  - 1つのルートテーブルを複数のサブネットで共有することはできるが、1つのサブネットに複数のルートテーブルを適用することは不可
  - VPCにはメインルートテーブルが存在し、サブネット作成時に指定しない場合のデフォルトテーブルとなる
  - ルートテーブルには、宛先アドレスとターゲットとなるGW(ネクストホップ)を指定する

### セキュリティグループ
- EC2,RDS等のインスタンス単位の通信制御に利用し、インスタンスは少なくとも1つのセキュリティグループをアタッチする必要がある
- インバウンドとアウトバウンドの両方の制御が可能
- 制御項目はプロトコル(TCP,UDP等)やポート範囲、送受信先のCIDRかセキュリティグループがある
- デフォルトでは**全ての通信を拒否**する設定となっており、設定した項目のみの通信を許可する

### ネットワークACL(NACL)
- ACLは`Access Control List`の略
- サブネットの通信制御に利用する
- 制御項目はセキュリティグループと同じだが、NACLは送受信先にセキュリティグループを指定できない
- デフォルトでは**全ての通信を許可**する設定となっている
- **セキュリティグループとNACLの違いはステートを保持するかしないか**
  - セキュリティグループはステートフルで、応答トラフィックはルールに関係なく許可される
  - NACLはステートレスで、応答トラフィックであろうと明示的に許可をしないと通信できない

### Internet Gateway
- VPCとインターネットを接続するためのゲートウェイで、各VPCに1つだけアタッチすることができる
- 設定項目は特になし
- 各VPCに1つしかアタッチできないので、SPOF(`Single Point Of Failure`:単一障害点)となる懸念があるが、IGWはマネージドサービスなのでAWS側でHA構成や復旧が行われる
- IGWにルーティングされているサブネットはパブリックサブネットと呼ばれる

### Virtual private GateWay
- VPCがVPNやDirectConnectと接続するためのゲートウェイ
- VGWも各VPCに1つしか作成できないが、複数のVPNやDirectConnectに接続できる

### VPCエンドポイント
- VPC内からインターネット上のAWSサービスする方法はIGWを使用する方法と、VPCエンドポイントと呼ばれる特殊なゲートウェイを利用する方法がある
- エンドポイントの種類
  - ゲートウェイエンドポイント
    - S3やDynamoDBと接続する際に利用する
  - インターフェースエンドポイント(`AWS PrivateLink`)
    - 上記以外のサービスとの接続で利用する

### VPCピアリング接続
- 2つのVPC間でプライベートな接続をするための機能
- 同一AWSアカウントのVPC間だけでなく、アカウントをまたがっての接続も可能
- 相手先のVPCがピアリングしている別のVPCに推移的に接続することはできない

![](./images/01-2.vpc.png)
